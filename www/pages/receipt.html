<template>
    <section class="page">
        <nav class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Back</span>
                    </a>
                </div>
                <div class="title">收款</div>
            </div>
        </nav>
        <div class="page-content">
            <div class="block-title"></div>
            <div class="block block-strong">
                <p>
                    <label class="checkbox">
                        <input type="checkbox" id="brightness">
                        <i class="icon-checkbox"></i>
                    </label>
                    增強亮度
                </p>
                <div id="qrcode"></div>
                <a href="#" data-popup=".my-popup" class="popup-open col button button-fill" @click="generateQRCode">產生收款QR Code</a>
            </div>
        </div>
        <div class="popup my-popup">
            <div class="view">
                <div class="page">
                    <div class="navbar">
                        <div class="navbar-inner">
                            <div class="title">收款QR Code</div>
                            <div class="right">
                                <!-- Link to close popup -->
                                <a class="link popup-close" href="#">Close</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="page-content">
                    ...
                </div>
            </div>
        </div>
    </section>
</template>

<script>
    return {
        methods: {
            generateQRCode: () => {

            }
        },
        on: {
            pageInit: function () {
                $('#brightness').change(() => {
                    if ($('#brightness').is(':checked')) {
                        brightness.setBrightness(1.0)
                    } else {
                        brightness.setBrightness(-1.0)
                    }
                })

                //讀取key file
                window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function (dirEntry) {
                    dirEntry.getFile('key.json', { create: true, exclusive: false }, function (fileEntry) {
                        readFile(fileEntry)
                    })
                })

                function readFile(fileEntry) {
                    fileEntry.file(function (file) {
                        let reader = new FileReader()
                        reader.onloadend = keyOnLoadend
                        reader.readAsText(file)
                    }, (evt) => {
                        alert(evt)
                    })
                }

                function keyOnLoadend() {
                    console.log(this.result)
                    let key = JSON.parse(this.result)

                    let jwt = JSON.parse(atob(storage.getItem('jwt').split('.')[1]))

                    let text = JSON.stringify({
                        ID: jwt.ID,
                        name: jwt.name,
                        address: key.address,
                    })

                    let qrcode = new QRCode('qrcode', {
                        text: text,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    })
                }
            },
            pageBeforeOut: function () { },
            pageBeforeRemove: function () { },
        },
    }
</script>