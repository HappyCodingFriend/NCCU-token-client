<template>
    <section class="page">
        <div class="page-content">
            <h1>政大錢包</h1>
            <form class="list no-hairlines-md" id="sign_in_form">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">帳號(學號or員工代號)</div>
                            <div class="item-input-wrap">
                                <input id="name" type="text" placeholder="Your name">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">密碼</div>
                            <div class="item-input-wrap">
                                <input id="password" type="text" placeholder="Your password">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>

                </ul>
            </form>
            <div class="block">
                <p>
                    <label class="checkbox">
                        <input type="checkbox" id="brightness">
                        <i class="icon-checkbox"></i>
                    </label>
                    記住密碼
                </p>
                <div class="row">
                    <a class="">註冊</a>
                    <a class="">忘記密碼</a>
                </div>
            </div>
            <div class="block">
                <div class="row">
                    <a href="/" class="col button button-fill">登入</a>
                    <button class="col button button-fill" @click="fingerprint_encrypt">指紋加密</button>
                    <button class="col button button-fill" @click="fingerprint_decrypt">指紋解密</button>
                </div>
            </div>
        </div>
    </section>
</template>

<script>
    return {
        methods: {
            sign_in: () => {
                console.log(app.form.convertToData('#sign_in_form'))
            },
            fingerprint_encrypt: () => {
                console.log('fingerprint')
                FingerprintAuth.isAvailable(isAvailableSuccess, isAvailableError)

                function isAvailableSuccess(result) {
                    console.log("FingerprintAuth available: " + JSON.stringify(result))
                    if (result.isAvailable) {
                        var encryptConfig = {
                            clientId: app.id,
                            username: $('input#name').val(),
                            password: $('input#password').val(),
                        }
                        FingerprintAuth.encrypt(encryptConfig, encryptSuccessCallback, encryptErrorCallback)

                        function encryptSuccessCallback(result) {
                            console.log("successCallback(): " + JSON.stringify(result))
                            if (result.withFingerprint) {
                                console.log("Successfully encrypted credentials.")
                                console.log("Encrypted credentials: " + result.token)
                                storage.setItem(encryptConfig.username, result.token)
                            } else if (result.withBackup) {
                                console.log("Authenticated with backup password")
                            }
                        }

                        function encryptErrorCallback(error) {
                            if (error === FingerprintAuth.ERRORS.FINGERPRINT_CANCELLED) {
                                console.log("FingerprintAuth Dialog Cancelled!")
                            } else {
                                console.log("FingerprintAuth Error: " + error)
                            }
                        }
                    }
                }

                function isAvailableError(message) {
                    console.log("isAvailableError(): " + message)
                    alert(message)
                }
            },
            fingerprint_decrypt: () => {

                if (!storage.getItem($('input#name').val())) {
                    alert('此帳號未設定指紋登入')
                } else {
                    var decryptConfig = {
                        clientId: app.id,
                        username: $('input#name').val(),
                        token: storage.getItem($('input#name').val()),
                    }
                    FingerprintAuth.decrypt(decryptConfig, successCallback, errorCallback)
                }

                function successCallback(result) {
                    console.log("successCallback(): " + JSON.stringify(result))
                    if (result.withFingerprint) {
                        console.log("Successful biometric authentication.")
                        if (result.password) {
                            console.log("Successfully decrypted credential token.")
                            console.log("password: " + result.password)
                            $('input#password').val(result.password)
                        }
                    } else if (result.withBackup) {
                        console.log("Authenticated with backup password")
                    }
                }

                function errorCallback(error) {
                    if (error === FingerprintAuth.ERRORS.FINGERPRINT_CANCELLED) {
                        console.log("FingerprintAuth Dialog Cancelled!")
                    } else {
                        console.log("FingerprintAuth Error: " + error)
                    }
                }
            },
        },
        on: {
            pageInit: function () {},
            pageBeforeOut: function () {},
            pageBeforeRemove: function () {},
        },
    }
</script>